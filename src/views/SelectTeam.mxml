<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009" 
		 xmlns:s="library://ns.adobe.com/flex/spark" 
		 xmlns:mx="library://ns.adobe.com/flex/mx" 
		 xmlns:views="views.*" width="100%" height="100%"
		 xmlns:layouts= "views.layouts.*"
		 
		 creationComplete="created(event)">
	
	<fx:Script>
		<![CDATA[
			import com.greensock.TweenMax;
			import com.greensock.easing.Sine;
			import com.utils.Console;
			
			import mx.events.FlexEvent;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			import spark.filters.GlowFilter;
			
			import events.KioskError;
			import events.KioskEvent;
			import events.KioskProgressEvent;
			import events.UserEvent;
			import events.ViewEvent;
			
			import model.ML;
			
			
			
			public var data:Object;
			
			[Bindable]
			public var type:String = "Game";
			
			[Bindable]
			public var teamDataList:XMLList;
			protected var teamFile:File;
			protected var stream:FileStream;
			private var myGlowIs:GlowFilter = new GlowFilter(0xffffff,1,12,12,2);
			private var noGlowIs:GlowFilter = new GlowFilter(0xffffff,0,0,0,0);
			
			protected var currentURN:String;
			
			
			public function created(event:FlexEvent=null):void
			{
				this.addEventListener( Event.INIT, init);
				init();
			}
			public function init(event:Event=null):void
			{
				Console.log("*** INIT SELECTTEAM ***", this);
		
				if (this.parentApplication.data!=null)
				{
					data = this.parentApplication.data;
					currentURN = data.urn;
					type = data.type;
					
					Console.log( data.type, this );
					
				}
				teamFile = File.applicationDirectory.resolvePath('assets/xml/teams.xml')
				readXML();
				
			}
			private function readXML():void 
			{
				
				// If it exists read it 
				if (teamFile.exists) {
					Console.log("team file exists", this);
					stream = new FileStream();
					stream.open(teamFile, FileMode.READ);
					processXMLData();
				}
				else //Otherwise make a file and save it
				{
					Console.log("no file", this);
					this.parentApplication.dispatchEvent(new KioskError(KioskError.ERROR, teamFile.url+" NOT FOUND", "COMMUNICATION ERROR", this.init));
				}
				
			}
			public function exit( e:Event = null):void
			{
				trace("*** EXIT SELECTTEAM ***");
			}
			
			protected function game(e:Event=null):void
			{
				this.parentApplication.dispatchEvent( new ViewEvent( ViewEvent.LOCATION_GAME ));
				
			}
			
			
			
			private function processXMLData():void 
			{
				trace("file size:"+stream.bytesAvailable);
				
				var xml:XML = XML(stream.readUTFBytes(stream.bytesAvailable));
				stream.close();
				teamDataList = (xml..team);
				this.createListeners();
				Console.log(teamDataList, this);
			}
			
			// this function was attempting to add a series of dummy elements to thin out the scrollbar by increasing the number of elements.
			// issues is that it is process intensive
			protected function modify(list:XMLList):XMLList
			{
				if (list.length()>0)
				{
					
					Console.log( list[0].toString(), this);
					var itemNo:int = 40;
					var node:XML = XML(list[0]).copy();
					node.@logo = ""; 
					var addinsNo:Number = Math.round(itemNo/list.length());
					var xmlCopy:XML = new XML(<mylist/>);
						
					var count:int = 0;
					for (var i:int=0;i<itemNo;i++)
					{
						if (i%addinsNo==0 || addinsNo<=1)
						{
							xmlCopy.appendChild( XML(list[count]).copy() );
							count++;
						} else {
							xmlCopy.appendChild( node.copy() );
						}
						
					}
					return xmlCopy..team;
				} else {
					return list;
				}
			}

			
			private function createListeners():void{
				for(var j:uint = 0; j < CarouselGroup.numElements; j++)
				{
					if (CarouselGroup.getElementAt( j )!=null)
					{
						//MOUSE EVENT
						CarouselGroup.getElementAt( j ).addEventListener(MouseEvent.CLICK, mySelect);
						CarouselGroup.getElementAt( j ).addEventListener(MouseEvent.ROLL_OVER, myRollOver);
						CarouselGroup.getElementAt( j ).addEventListener(MouseEvent.ROLL_OUT, myRollOut);
						
						
					}
				}
			}
			
			private function mySelect(event:MouseEvent):void
			{
					var currentIndex:int = -1;
					
					for(var j:uint = 0; j < CarouselGroup.numElements; j++)
					{
						if (CarouselGroup.getElementAt( j )==event.currentTarget)
						{
							currentIndex = j;
							Console.log("currentIndex: "+currentIndex,this)
						}
					}
					/*
					
					TweenMax.to(CarouselGroup.getElementAt( currentIndex ), .5, 
						{ scaleX: 1.2, scaleY: 1.2, ease: com.greensock.easing.Sine.easeOut, 
							onComplete: function():void { gotoTeam(teamDataList[currentIndex].@name.toString()) 
							} 
						}); 
					*/
					Console.log( "currentIndex: "+ teamDataList[currentIndex].@name, this );
					publish( teamDataList[currentIndex].@id )
			}
			protected function publish( teamID:int ):void
			{
				var passVars:Object=new Object();
				passVars.urn=currentURN;
				passVars.team_id= teamID;
				
				publishSelectTeam.send(passVars);
				//this.parentApplication.dispatchEvent( new KioskProgressEvent( KioskProgressEvent.UPDATE_COMPLETE ));
				
			}
			protected function publish_success(event:ResultEvent):void
			{
				//this.parentApplication.dispatchEvent( new KioskProgressEvent( KioskProgressEvent.UPDATE_COMPLETE ));
				if(event.result.result!="SUCCESS") 
				{
					this.parentApplication.dispatchEvent(new KioskError(KioskError.ERROR, event.result.message, "ERROR", init));
				} else 
				{
					complete();
				}
			}
			protected function publish_failed(event:FaultEvent):void
			{
				this.parentApplication.dispatchEvent(new KioskError(KioskError.ERROR, event.fault.faultString, "NETWORK ERROR"));
				
			}
			protected function complete():void
			{
				this.parentApplication.dispatchEvent( new ViewEvent( ViewEvent.LOCATION_REGISTRATION_COMPLETE, data ) );
			}
			
			//Roll Over ... Add Glow
			private function myRollOver(event:MouseEvent):void{	
				event.currentTarget.filters =[myGlowIs];
			}
			//Roll Out ... Remove Glow
			private function myRollOut(event:MouseEvent):void{	
				event.currentTarget.filters = null;
			}
			]]>
	</fx:Script>
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
		<s:Power id="powerEasing" exponent="4"/>
		<s:Sine id="sineEasing" easeInFraction="0.3"/>
		<s:Linear id="slowDown" easeInFraction=".1" easeOutFraction=".1"  />
		<s:HTTPService id="publishSelectTeam" resultFormat="flashvars" method="POST" url="{this.parentApplication.localURL+'userTeam.php'}" result="publish_success(event)" fault="publish_failed(event)" />

	</fx:Declarations>
	<!-- Menu -->
	<!-- Field -->
		<s:VGroup height="100%" width="100%" verticalAlign="middle" horizontalAlign="center"  >
			<s:DataGroup id="CarouselGroup" horizontalCenter="0" height="260" width="1200" itemRenderer="views.renderer.logoItemRenderer">			
				<s:layout>
					<s:TileLayout orientation="rows" clipAndEnableScrolling="true"
								  requestedColumnCount="-1" requestedRowCount="-1"
								  verticalGap="12" horizontalGap="12" useVirtualLayout="true" />
				</s:layout>
				<s:XMLListCollection  id="teamList"   source="{teamDataList}"/>	
			</s:DataGroup>
		</s:VGroup>
			
			
</s:Group>
